var submission={};var remaining=0;var payment={};payment.payments={cash:0,card:0};$(document).ready(function(){$(".orders-list-item").click(function(){$(".orders-list-item").removeClass("active");$(this).addClass("active");var a=$(this).find(".order-id").val();$.post("ajax_request",{task:"submission_order_details",id:a},function(b){b=JSON.parse(b);remaining=(parseFloat(b.order_info.total)-parseFloat(b.order_payment)).toFixed(3);submission.order=b.order_info.order_id;$(".order-panel").html(b.html);ini_order();$(".payment-panel .customer").html(b.customer.name+" - "+b.customer.mobile_num);$(".payment-panel .total").html("BD "+b.order_info.total);$(".payment-panel .payment").html("BD "+b.order_payment);$(".payment-panel .remaining").html("BD "+remaining);$(".remaining").removeClass("validation-error")})});$(".orders-list-item:first").click();$(".open-filter").click(function(){$("#filter-dialog").modal()});$("#pay").click(function(){if(submission.order==null){return false}submission.lines={};var a=1;$(".pending .order-line .line-id:checked").each(function(){submission.lines[a]=$(this).val();a++});if(submission.lines[1]==undefined){$(".pending").addClass("validation-error");return false}else{$(".pending").removeClass("validation-error")}submission.payment=payment;if(verifyPayment()){$(".overlay").show();$.post("ajax_request",{task:"submit_order",submission:JSON.stringify(submission)},function(e){var d=window.innerHeight;var b=window.innerWidth-20;var c=siteURL+"/printing/print_submission?action="+e;if(typeof Android=="object"){Android.openPrint(c)}else{window.open(c,"Printing","scrollbars,resizable,height="+d+",width="+b)}window.location.href="submission"})}});$(".payment-type").on("change",function(){var b=$(this).val();var c=getPrice(".given-input");var a=(remaining-parseFloat(payment.payments["cash"])-parseFloat(payment.payments["card"])).toFixed(3);if((b=="card"&&a<c)||c==0){$("#payment-dialog").find(".given-input").val(a)}else{$("#payment-dialog").find(".given-input").val(c)}$("#payment-dialog").find(".given-input").focus();$(".given-input").removeClass("validation-error")});$(".open-keypad").on("click",function(){var a=$(this).closest(".has-soft-keypad");$(".soft-keypad").addClass("opened");a.find("input").focus()});$(".has-soft-keypad input").on("change",function(){$(".soft-keypad").removeClass("opened")});$(".close-dialog").click(function(){$.modal.close()});$(".given-input").on("blur",function(){$(this).change()});$(".given-input").on("focus",function(){$(this).change().select()});$(".given-input").on("change",function(){var a=getPrice(".given-input");$(".given-input").val("BD "+a.toFixed(3))});$(".payments-list").on("click",".remove-payment",function(){var a=$(this).attr("data-type");payment.payments[a]=0;preparePayment()});ini_keys();$(window).resize(function(){if(window.innerWidth<768){$("body").removeClass("nav-sm");$("body").addClass("nav-md")}else{$("body").removeClass("nav-md");$("body").addClass("nav-sm")}}).resize();$(".open-tab").click(function(){$(".open-tab").closest("li").removeClass("active");$(".info-col").removeClass("active");$(this).closest("li").addClass("active");$("."+$(this).attr("data-tab")).addClass("active")})});function ini_order(){payment={};payment.payments={cash:0,card:0};preparePayment();$(".pending .order-line").click(function(){if($(this).hasClass("active")){$(this).removeClass("active");$(this).find(".line-id").prop("checked",false)}else{$(this).addClass("active");$(this).find(".line-id").prop("checked",true)}})}function preparePayment(){var c=0;var b="";$(".payments-list").html("");if(payment.payments["cash"]>0){b+="<div class='payment-line'><div class='col-xs-4'><i class='fa fa-money fa-fw'></i> Cash</div><div class='col-xs-8'>BD "+payment.payments["cash"].toFixed(3)+"<div class='btn btn-sm btn-danger pull-right remove-payment' data-type='cash'><i class='fa fa-remove'></i></div></div><div class='clearfix'></div></div>";c+=parseFloat(payment.payments["cash"])}if(payment.payments["card"]>0){b+="<div class='payment-line'><div class='col-xs-4'><i class='fa fa-credit-card fa-fw'></i> Card</div><div class='col-xs-8'>BD "+payment.payments["card"].toFixed(3)+"<div class='btn btn-sm btn-danger pull-right remove-payment' data-type='card'><i class='fa fa-remove'></i></div></div><div class='clearfix'></div></div>";c+=parseFloat(payment.payments["card"])}var a=remaining-c;var d=0;$(".remaining").removeClass("validation-error");$(".changes-block").removeClass("active");if(a<0){d=-a;a=0;$(".changes-block").addClass("active")}payment.changes=d;if(c==0){$(".payments-list").html("<h4 class='alert text-center'>No payments added</h4>")}else{$(".payments-list").html(b)}$(".remaining").html("BD "+a.toFixed(3));$(".changes").html("BD "+d.toFixed(3))}function verifyPayment(){var a=true;return a}function ini_keys(){$(".key").on("mousedown",function(a){a.preventDefault()});$(".key").on("click",function(f){var j=$(".form-control:focus");var l=$(this).attr("data-key");var g=$(this).attr("data-fun");if(j.length>0){if(l!=null){var k=j.val();k=k.slice(0,j[0].selectionStart)+l+k.slice(j[0].selectionEnd);j.val(k)}if(g!=null){switch(g){case"del":var k=j.val();j.val(k.substring(0,k.length-1));break;case"percent_disc":var k=parseFloat(j.val());var c=$(".discount-type:checked").val();if(isNaN(k)){k=0}if(k>100){k=0}if(c=="total"){for(var b in order){order[b].discount=k}}else{if(c=="line"){var a=$(".order-line.active").find(".id").val();order[a].discount=k}}j.val("");updateOrder();$.modal.close();break;case"amount_disc":var k=parseFloat(j.val());var c=$(".discount-type:checked").val();var h=0;var d=0;if(isNaN(k)){k=0}if(c=="total"){for(var b in order){h+=order[b].price*order[b].quantity}if(h>0&&k<h){d=(k/h)*100}for(var b in order){order[b].discount=d}}else{if(c=="line"){var a=$(".order-line.active").find(".id").val();h=order[a].price*order[a].quantity;if(h>0&&k<h){d=(k/h)*100}order[a].discount=d}}j.val("");updateOrder();$.modal.close();break;case"clear":j.val("");break;case"checkout":goToCheckout();break;case"add-payment":addPayment();break;case"pay":pay();break;case"enter":j.change();break;case"change-qty":var m=$(".order-line.active");var a=m.find(".id").val();var k=parseFloat(j.val());if(isNaN(k)){k=1}order[a].quantity=k;updateLine(m);findTotal();$.modal.close();break;case"goToPayment":if((remaining-parseFloat(payment.payments["cash"])-parseFloat(payment.payments["card"])).toFixed(3)>0){$("#payment-dialog").modal();$("#payment-dialog .given-input").focus();$("#payment-dialog").find(".payment-type:first").prop("checked",true);$("#payment-dialog").find(".payment-type").change()}else{$(".remaining").addClass("validation-error")}break;default:}}}else{if(g!=null){switch(g){case"del":var m=$(".order-line.active");if(m.length>0){var a=m.find(".id").val();m.remove();delete order[a];$(".order-line").removeClass("active");$(".order-line:last").addClass("active");findTotal()}break;case"qty":var m=$(".order-line.active");if(m.length>0){var a=m.find(".id").val();$("#qty-dialog").modal();$("#qty-dialog").find(".qty-input").val(order[a].quantity);$("#qty-dialog").find(".qty-input").focus()}break;case"plus":var m=$(".order-line.active");if(m.length>0){var a=m.find(".id").val();order[a].quantity++;updateLine(m);findTotal()}break;case"minus":var m=$(".order-line.active");if(m.length>0){var a=m.find(".id").val();if(order[a].quantity>1){order[a].quantity--}updateLine(m);findTotal()}break;case"disc":$("#disc-dialog").modal();$("#disc-dialog").find(".discount-input").focus();$("#disc-dialog").find(".discount-type:first").prop("checked",true);break;case"checkout":goToCheckout();break;case"goToPayment":if((remaining-parseFloat(payment.payments["cash"])-parseFloat(payment.payments["card"])).toFixed(3)>0){$("#payment-dialog").modal();$("#payment-dialog .given-input").focus();$("#payment-dialog").find(".payment-type:first").prop("checked",true);$("#payment-dialog").find(".payment-type").change()}else{$(".remaining").addClass("validation-error")}break;case"add-payment":addPayment();break;case"pay":pay();break;case"customer":$("#customer-dialog").modal();break;case"reset":if(lineId>0){if(confirm("Sure to reset the data?")){resetOrder()}}break;default:}}}})}function getPrice(a){var b=parseFloat($(a).val().replace("BD ",""));if(isNaN(b)){b=0}return b}function goToCheckout(){$.modal.close()}function addPayment(){var b=getPrice(".given-input");var a=$(".payment-type:checked").val();$(".given-input").removeClass("validation-error");switch(a){case"cash":if(b>0){payment.payments["cash"]=b}break;case"card":if(b>0){if((remaining-payment.payments["cash"]).toFixed(3)>=b){payment.payments["card"]=b}else{$(".given-input").addClass("validation-error");return false}}break}$(".given-input").val(0);preparePayment();$.modal.close()};