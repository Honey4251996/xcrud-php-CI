
var service=null;var order={};var payment={};payment.payments={cash:0,card:0};var lineId=0;var totalAmount=0;var customer=null;var checkout_stage=0;var diff;window.onbeforeunload=function(a){if(lineId>0){if(terminal==true){if(confirm("Do you want to leave without saving ?")){}else{a.returnValue=false}}else{a.returnValue=false}}};$(document).ready(function(){serviceSlider();$(window).resize(function(){diff=$(".service-container").outerWidth()-$(".service-panel").outerWidth()});$(".key").on("mousedown",function(a){a.preventDefault()});$(".key").on("click",function(f){var k=$(".form-control:focus");var m=$(this).attr("data-key");var h=$(this).attr("data-fun");if(k.length>0){if(m!=null){var l=k.val();l=l.slice(0,k[0].selectionStart)+m+l.slice(k[0].selectionEnd);k.val(l)}if(h!=null){switch(h){case"del":var l=k.val();k.val(l.substring(0,l.length-1));break;case"percent_disc":var l=parseFloat(k.val());var c=$(".discount-type:checked").val();if(isNaN(l)){l=0}if(l>100){l=0}if(c=="total"){for(var b in order){order[b].discount=l}}else{if(c=="line"){var a=$(".order-line.active").find(".id").val();order[a].discount=l}}k.val("");updateOrder();$.modal.close();break;case"amount_disc":var l=parseFloat(k.val());var c=$(".discount-type:checked").val();var j=0;var d=0;if(isNaN(l)){l=0}if(c=="total"){for(var b in order){j+=order[b].price*order[b].quantity}if(j>0&&l<j){d=(l/j)*100}for(var b in order){order[b].discount=d}}else{if(c=="line"){var a=$(".order-line.active").find(".id").val();j=order[a].price*order[a].quantity;if(j>0&&l<j){d=(l/j)*100}order[a].discount=d}}k.val("");updateOrder();$.modal.close();break;case"clear":k.val("");break;case"checkout":goToCheckout();break;case"add-payment":addPayment();break;case"pay":pay();break;case"enter":k.change();break;case"change-qty":var n=$(".order-line.active");var a=n.find(".id").val();var l=parseFloat(k.val());if(isNaN(l)){$(".qty-input").addClass("validation-error");return false}else{if(l<=0){$(".qty-input").addClass("validation-error");return false}}order[a].quantity=l;updateLine(n);findTotal();$.modal.close();break;case"calculate-rectangle-area":var n=$(".order-line.active");if(calculate_rectangle_area(n)){updateLine(n);findTotal();$.modal.close()}else{return false}break;default:}}}else{if(h!=null){switch(h){case"del":var n=$(".order-line.active");delete_line(n);break;case"qty":var n=$(".order-line.active");if(n.length>0){var a=n.find(".id").val();var g="#"+order[a].dialog;$(g).modal();if(g=="#qty-dialog"){$(g).find(".qty-input").removeClass("validation-error");$(g).find(".qty-input").val(order[a].quantity);$(g).find(".qty-input").focus().select()}else{if(g=="#area-rectangle-dialog"){$(g).find(".form-control").removeClass("validation-error");$(g).find(".form-control").val("");$(g).find(".width-input").focus().select()}}}break;case"plus":var n=$(".order-line.active");if(n.length>0){var a=n.find(".id").val();order[a].quantity++;updateLine(n);findTotal()}break;case"minus":var n=$(".order-line.active");if(n.length>0){var a=n.find(".id").val();if(order[a].quantity>1){order[a].quantity--}updateLine(n);findTotal()}break;case"disc":$("#disc-dialog").modal();$("#disc-dialog").find(".discount-input").focus();$("#disc-dialog").find(".discount-type:first").prop("checked",true);break;case"checkout":goToCheckout();break;case"goToPayment":if((totalAmount-parseFloat(payment.payments["cash"])-parseFloat(payment.payments["card"])).toFixed(3)>0){$("#payment-dialog").modal();$("#payment-dialog .given-input").focus();$("#payment-dialog").find(".payment-type:first").prop("checked",true);$("#payment-dialog").find(".payment-type").change()}else{$("#checkout-dialog .remaining").addClass("validation-error")}break;case"add-payment":addPayment();break;case"pay":pay();break;case"customer":$("#customer-dialog").modal();break;case"reset":if(lineId>0){if(confirm("Sure to reset the data?")){resetOrder()}}break;case"calculate-rectangle-area":var n=$(".order-line.active");if(calculate_rectangle_area(n)){updateLine(n);findTotal();$.modal.close()}else{return false}break;default:}}}});$(".service").on("click",function(){var b=$(this).attr("data-id");var a=$(this).attr("data-name");$(".service").removeClass("active");$(".item").removeClass("active");$(".service"+b).addClass("active");$(this).addClass("active");service={id:b,name:a}});$(".service:first").click();$("body").on("click",".order-line",function(){$(".order-line").removeClass("active");$(this).addClass("active")});$(".item").on("click",function(){if(service!=null){var c=parseFloat($(this).attr("data-service"+service.id));var b=1;var i=$(this).attr("data-name");var f=$(this).attr("data-id");var e=$(this).attr("data-unit");var d=$(this).attr("data-dialog");var g=$(this).attr("data-showDialog");if(g=="1"){b=0}var a={service:service.id,serviceName:service.name,item:f,itemName:i,price:c,quantity:b,discount:0,unit:e,dialog:d,systemNote:"",userNote:""};order[lineId]=a;var h=orderLine(lineId,service.name,i,c,b,e,0);$(".order-details").append(h);$(".order-line").removeClass("active");$(".order-line:last").addClass("active");findTotal();lineId++;if(g=="1"){$(".key[data-fun='qty']").click()}}});$(".discount-type").on("change",function(){$("#disc-dialog").find(".discount-input").focus()});$(".payment-type").on("change",function(){var b=$(this).val();var c=getPrice(".given-input");var a=(totalAmount-parseFloat(payment.payments["cash"])-parseFloat(payment.payments["card"])).toFixed(3);if((b=="card"&&a<c)||c==0){$("#payment-dialog").find(".given-input").val(a)}else{$("#payment-dialog").find(".given-input").val(c)}$("#payment-dialog").find(".given-input").focus();$(".given-input").removeClass("validation-error")});$(".given-input").on("blur",function(){$(this).change()});$(".given-input").on("focus",function(){$(this).change().select()});$(".given-input").on("change",function(){var a=getPrice(".given-input");$(".given-input").val("BD "+a.toFixed(3))});$(".save-customer").on("click",function(){var a=$("#customer-dialog .xcrud-ajax");var b=Xcrud.list_data(a,this);if(b.task=="save"){if(!Xcrud.validation_error){Xcrud.unique_check(a,b,function(c){b.task="save";Xcrud.request(c,b)})}else{Xcrud.show_message(a,Xcrud.lang("validation_error"),"error")}}else{Xcrud.request(a,b)}});$(".select-customer").on("click",function(){customer=0;$(".save-customer").click()});init_customer();$(".close-dialog").click(function(){$.modal.close()});$(".payments-list").on("click",".remove-payment",function(){var a=$(this).attr("data-type");payment.payments[a]=0;preparePayment()});$(window).resize(function(){if(window.innerWidth<768){$("body").removeClass("nav-sm");$("body").addClass("nav-md")}else{$("body").removeClass("nav-md");$("body").addClass("nav-sm")}}).resize();$(".order-column").on("click",".open-panel",function(){if($(".order-column").hasClass("open")){$(".order-column").removeClass("open")}else{$(".order-column").addClass("open")}});$(".order-column,.item-panel").swipe(function(a,b){if(b>0){$(".order-column").removeClass("open")}else{$(".order-column").addClass("open")}})});$(document).on("modal:close",function(){changes=false;checkout_stage=0;if(customer!=null){$(".customer-selection").val(customer).change()}var a=$(".order-line.active");if(a.length>0){var b=a.find(".id").val();if(order[b].quantity<=0){delete_line(a)}}});jQuery(document).on("xcrudafterrequest",function(c,b,d,a){init_customer();if(d.task=="save"&&a=="success"){if(customer===0){customer=$(".customer-selection").val();$(".customer-info").html($(".customer-selection").find("option:selected").html());if(checkout_stage==1){goToCheckout()}else{$.modal.close()}}}});function serviceSlider(){diff=$(".service-container").outerWidth()-$(".service-panel").outerWidth();var a=200;$(".service-panel .go-right").on("click",function(){var c=parseFloat($(".service-container").css("left"));var b=(a-c<=diff)?a:diff+c;if(-c<diff){$(".service-container").stop();$(".service-container").animate({left:"-="+b+"px"},b,function(){c-=b})}});$(".service-container").swipeLeft(function(){$(".service-panel .go-right").click()});$(".service-panel .go-left").on("click",function(){var c=parseFloat($(".service-container").css("left"));var b=(c<=-a)?a:-c;if(c<0){$(".service-container").stop();$(".service-container").animate({left:(c+b)+"px"},b,function(){c+=b})}});$(".service-container").swipeRight(function(){$(".service-panel .go-left").click()})}function init_customer(){$(".customer-selection").on("change",function(){var b=$(this).val();if(b==0){$(".xcrud-input").each(function(){var c=$(this).attr("data-name");if(c!=null){$(this).val("")}});$(".xcrud-data[name='task']").val("create");$(".xcrud-data[name='primary']").remove()}else{$(".xcrud-data[name='task']").val("edit");var a=$(".xcrud-data[name='primary']");if(a.length>0){a.val(b)}else{$(".xcrud-data[name='task']").after("<input type='hidden' class='xcrud-data' name='primary' value='"+b+"' />")}$.post("ajax_request",{task:"get_customer",id:b},function(c){c=JSON.parse(c);$(".xcrud-input").each(function(){var d=$(this).attr("data-name");if(c[d]!=null){$(this).val(c[d])}})})}})}function orderLine(a,e,i,d,b,f,h){var g=d*b*(1-h/100);var c="<div class='order-line'>";c+="<div class='row'>";c+="<input class='id' type='hidden' value = "+a+" >";c+="<div class='col-xs-6 line-item'>"+i+" - "+e+"</div>";c+="<div class='col-xs-3 quantity text-right'>"+b+" "+f+"</div>";c+="<div class='col-xs-3 text-right pirce'>BD "+d.toFixed(3)+"</div>";c+="<div class='clearfix'></div></div>";c+="<div class='row'>";c+="<div class='col-xs-4 discount'>";if(h>0){c+="Disc: "+order[a].discount.toFixed(2)+"%"}c+="</div>";c+="<div class='col-xs-5 text-right'>SubTotal</div>";c+="<div class='col-xs-3 subtotal text-right'>BD "+g.toFixed(3)+"</div>";c+="<div class='clearfix'></div></div></div>";return c}function updateLine(b){var d=b.find(".id").val();var a=order[d].price*order[d].quantity*(1-order[d].discount/100);if(order[d].discount>0){b.find(".discount").html("Disc: "+order[d].discount.toFixed(2)+"%")}else{b.find(".discount").html("")}if(order[d].systemNote!=""){var c=b.find(".line-item").html();b.find(".line-item").find(".system-note").remove();b.find(".line-item").html("<span class='system-note'>"+order[d].systemNote+"</span> "+b.find(".line-item").html())}else{b.find(".line-item").find(".system-note").remove()}b.find(".quantity").html(order[d].quantity+" "+order[d].unit);b.find(".subtotal").html("BD "+a.toFixed(3))}function findTotal(){var b=0;for(var a in order){b+=order[a].price*order[a].quantity*(1-order[a].discount/100)}totalAmount=b;preparePayment();$(".total").html("BD "+b.toFixed(3))}function updateOrder(){$(".order-line").each(function(){updateLine($(this))});findTotal()}function resetOrder(){order={};payment={};payment.payments={cash:0,card:0};lineId=0;totalAmount=0;customer=null;$(".customer-selection").val(0).change();$(".customer-info").html("No Customer");$(".order-details").html("");findTotal()}function goToCheckout(){$(".remaining").removeClass("validation-error");if(totalAmount>0){if(customer==null){checkout_stage=1;$("#customer-dialog").modal()}else{$("#checkout-dialog").modal()}}else{$("#warning-dialog").html("<h1 class='alert text-center'>No Items Selected</h1>").modal()}}function addPayment(){var b=getPrice(".given-input");var a=$(".payment-type:checked").val();$(".given-input").removeClass("validation-error");switch(a){case"cash":if(b>0){payment.payments["cash"]=b}break;case"card":if(b>0){if((totalAmount-payment.payments["cash"]).toFixed(3)>=b){payment.payments["card"]=b}else{$(".given-input").addClass("validation-error");return false}}break}$(".given-input").val(0);preparePayment();goToCheckout()}function preparePayment(){var b=0;var a="";payment.total=totalAmount;$(".payments-list").html("");if(payment.payments["cash"]>0){a+="<div class='payment-line'><div class='col-xs-4'><i class='fa fa-money fa-fw'></i> Cash</div><div class='col-xs-8'>BD "+payment.payments["cash"].toFixed(3)+"<div class='btn btn-sm btn-danger pull-right remove-payment' data-type='cash'><i class='fa fa-remove'></i></div></div><div class='clearfix'></div></div>";b+=parseFloat(payment.payments["cash"])}if(payment.payments["card"]>0){a+="<div class='payment-line'><div class='col-xs-4'><i class='fa fa-credit-card fa-fw'></i> Card</div><div class='col-xs-8'>BD "+payment.payments["card"].toFixed(3)+"<div class='btn btn-sm btn-danger pull-right remove-payment' data-type='card'><i class='fa fa-remove'></i></div></div><div class='clearfix'></div></div>";b+=parseFloat(payment.payments["card"])}var d=totalAmount-b;var c=0;$(".remaining").removeClass("validation-error");$(".changes-block").removeClass("active");if(d<0){c=-d;d=0;$(".changes-block").addClass("active")}payment.changes=c;if(b==0){$(".payments-list").html("<h4 class='alert text-center'>No payments added</h4>")}else{$(".payments-list").html(a)}$(".remaining").html("BD "+d.toFixed(3));$(".changes").html("BD "+c.toFixed(3))}function verifyPayment(){var a=true;return a}function pay(){preparePayment();if(verifyPayment()){$.modal.close();$(".overlay").show();$.post("ajax_request",{task:"save_order",order:JSON.stringify(order),payment:JSON.stringify(payment),customer:customer},function(d){var c=window.innerHeight;var a=window.innerWidth-20;var b=siteURL+"/printing/print_collection?action="+d;if(typeof Android=="object"){Android.openPrint(b)}else{window.open(b,"Printing","scrollbars,resizable,height="+c+",width="+a)}resetOrder();$(".overlay").hide()})}}function getPrice(a){var b=parseFloat($(a).val().replace("BD ",""));if(isNaN(b)){b=0}return b}function calculate_rectangle_area(b){var g=b.find(".id").val();var d=$("#area-rectangle-dialog");var e=parseFloat(d.find(".width-input").val());var a=parseFloat(d.find(".height-input").val());var c=false;var f=0;if(isNaN(e)){d.find(".width-input").addClass("validation-error");c=true}else{if(e<=0){d.find(".width-input").addClass("validation-error");c=true}else{d.find(".width-input").removeClass("validation-error")}}if(isNaN(a)){d.find(".height-input").addClass("validation-error");c=true}else{if(a<=0){d.find(".height-input").addClass("validation-error");c=true}else{d.find(".height-input").removeClass("validation-error")}}if(c){return false}else{f=(e*a).toFixed(3)}order[g].quantity=f;order[g].systemNote=e+"m x "+a+"m";return true}function delete_line(a){if(a.length>0){var b=a.find(".id").val();a.remove();delete order[b];$(".order-line").removeClass("active");$(".order-line:last").addClass("active");findTotal()}};